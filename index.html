<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>PascalCollab</title>

        <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>

        <!-- Ace -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/mode-c_cpp.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/theme-monokai.js"></script>

        <!-- Firepad -->
        <link rel="stylesheet" href="https://cdn.firebase.com/libs/firepad/1.4.0/firepad.css" />
        <script src="https://cdn.firebase.com/libs/firepad/1.4.0/firepad.min.js"></script>

        <link rel="stylesheet" type="text/css" href="/assets/styles.css">

    </head>
    <body onLoad="init()">

        <div id="container">
            <div id="header">Бессмысленное и беспощедное дерьмо</div>
            <div id="sidebar">
                <p><button onClick="Ex1()">Example 1</button></p>
                <p><button onClick="Ex2()">Example 2</button></p>
            </div>
            <div id="content">
                <div id="editor"></div>
 
                <ul class="tabs">
                    <li id="selected" class="stdinL"><a href="javascript:void(0)" onclick="changeTab('stdin')">Input</a></li>
                    <li class="outputL"><a href="javascript:void(0)" onclick="changeTab('output')">Output</a></li>
                    <li class="errorsL"><a href="javascript:void(0)" onclick="changeTab('errors')">Errors</a></li>
                </ul>
                <div> <!--Тут контейнер!!!-->
                    <textarea id="stdin" class="tab"></textarea>
                    <textarea id="output" class="tab" readonly="readonly"></textarea>
                    <textarea id="errors" class="tab" readonly="readonly"></textarea>

                    <button onClick="sendCode()" id="button">Send</button>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            var output = document.getElementById("output");
            var stdin = document.getElementById("stdin");
            var errors = document.getElementById("errors");
            var editor = ace.edit("editor");
            var session = editor.getSession();
            session.setUseWrapMode(true);
            session.setUseWorker(false);
            editor.setTheme("ace/theme/monokai");
            editor.getSession().setMode("ace/mode/c_cpp");

            output.value = ''
            stdin.value = ''
            errors.value = ''

            var firepad;
            var firepadRef;

            function init() {
                var config = {
                    apiKey: "AIzaSyDZp3pyrbZm34cnXJcVB5PzUeUOAkeaGHA",
                    authDomain: "pascalcollab.firebaseapp.com",
                    databaseURL: "https://pascalcollab.firebaseio.com"
                };
                firebase.initializeApp(config);
                firepadRef = getExampleRef();
                firepad = Firepad.fromACE(firepadRef, editor, {
                    defaultText: '#include <iostream>;\r\n\r\nusing namespace std;\r\n\r\nint main(){\r\n\r\n    cout << \"Hello World!\" << endl;\r\n\r\n    return 0;\r\n}\r\n'
                });
            }

            function getExampleRef() {
                var ref = firebase.database().ref();
                var hash = window.location.hash.replace(/#/g, '');
                if (hash) {
                    ref = ref.child(hash);
                } else {
                    ref = ref.push(); // generate unique location.
                    window.location = window.location + '#' + ref.key; // add it as a hash to the URL.
                }
                console.log('Firebase data: ', ref.toString());
                return ref;
            }
            
            function Ex1(){
                var hash = window.location.hash.replace(/#/g, '');
                if(hash != '-KbecJaQd_evyTFkLuHV'){
                    window.location = '#' + '-KbecJaQd_evyTFkLuHV';
                    firepadRef = getExampleRef();
                    firepad.dispose()
                    editor.setValue('')
                    firepad = Firepad.fromACE(firepadRef, editor)
                }
            }

            function Ex2(){
                var hash = window.location.hash.replace(/#/g, '');
                if(hash != '-KbeeU8CZgax96b9uk-9'){
                    window.location = '#' + '-KbeeU8CZgax96b9uk-9';
                    firepadRef = getExampleRef();
                    firepad.dispose()
                    editor.setValue('')
                    firepad = Firepad.fromACE(firepadRef, editor)
                }
            }

            function changeTab(tabName){
                var i
                var x = document.getElementsByClassName("tab")

                for (i = 0; i < x.length; i++) {
                    x[i].style.display = 'none'
                }

                document.getElementById(tabName).style.display = "block"
                document.getElementById('selected').id = ''
                document.getElementsByClassName(tabName + 'L')[0].id = 'selected'
            }

            
            function sendCode(){
                var xhr = new XMLHttpRequest()
                var body = JSON.stringify({
                    code: editor.getSession().getValue(),
                    input: stdin.value
                });

                output.value = ''
                stdin.value = ''
                errors.value = ''

                xhr.open('POST', '/compile', true)
                xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8')
                xhr.send(body)
                xhr.onreadystatechange = function() {
                    if (xhr.readyState != 4) return;

                    button.innerHTML = "Send"
                    button.disabled = false
                    var res = JSON.parse(xhr.responseText)
                    output.value = res.output
                    errors.value = res.err
                    if(res.output != ''){
                        changeTab('output')
                    }
                    if(res.output === '' && res.errors != ''){
                        changeTab('errors')
                    }
                }

                button.innerHTML = 'Loading...'
                button.disabled = true
                setTimeout(() => {button.innerHTML = "Send"; button.disabled = false}, 6500)
            }
        </script>
    </body>
</html>
